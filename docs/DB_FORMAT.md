# Rebrew Database Formats

The `rebrew` tooling ecosystem uses SQLite databases to power its reverse-engineering, matching, and coverage dashboard workflows. This document details the schema and purpose of the two primary database formats:

1. **`coverage.db`** - The persistent SQLite database generated by `rebrew-build-db` driving the `recoverage` development server and UI dashboard.
2. **`reccmp` In-Memory Database** - The temporary comparison database used by `reccmp` to track matching entities between the original and recompiled binaries.

---

## 1. `coverage.db` (Recoverage Dashboard DB)

### Overview
This database is generated by the `rebrew-build-db` tool (defined in `rebrew/src/rebrew/builddb.py`). It aggregates `data_*.json` files generated across different compilation targets into a single queried persistence layer for `recoverage/server.py`. The DB lives in the `db/` directory of the project workspace. 

The table design supports multi-target binaries by including a `target` column in nearly all tables.

### `functions` Table
Stores details regarding decompiled and original functions.

| Column | Type | Description |
|---|---|---|
| `target` | `TEXT` | The binary target (e.g., `server_dll`). Part of the primary key. |
| `va` | `INTEGER` | The Virtual Address of the function. Part of the primary key. |
| `name` | `TEXT` | The name of the function. Indexed. |
| `vaStart` | `TEXT` | Hex string representation of the starting virtual address. |
| `size` | `INTEGER` | Byte size of the function. |
| `fileOffset` | `INTEGER` | Physical file offset of the function in the binary. |
| `status` | `TEXT` | E.g. implementation or exact-match status. |
| `origin` | `TEXT` | Origin file/library if known. |
| `cflags` | `TEXT` | Compilation flags (if any). |
| `symbol` | `TEXT` | The raw mangled or internal symbol name. |
| `markerType` | `TEXT` | Associated marker type. |
| `ghidra_name` | `TEXT` | Function name as defined in Ghidra. |
| `r2_name` | `TEXT` | Function name as defined in radare2. |
| `is_thunk` | `BOOLEAN` | True if the function is a thunk. |
| `is_export` | `BOOLEAN` | True if the function is exported. |
| `sha256` | `TEXT` | Hash of the function's bytecode. |
| `files` | `TEXT` | JSON array of associated source files. |

### `globals` Table
Tracks global variables mapped during the decompilation effort.

| Column | Type | Description |
|---|---|---|
| `target` | `TEXT` | The binary target. Part of the primary key. |
| `va` | `INTEGER` | The Virtual Address. Part of the primary key. |
| `name` | `TEXT` | Variable name. Indexed. |
| `decl` | `TEXT` | Variable C/C++ declaration syntax. |
| `files` | `TEXT` | JSON array of associated source files. |

### `sections` Table
Defines binary sections (e.g., `.text`, `.data`, `.rdata`).

| Column | Type | Description |
|---|---|---|
| `target` | `TEXT` | The binary target. Part of primary key. |
| `name` | `TEXT` | Section name (e.g. `.text`). Part of primary key. |
| `va` | `INTEGER` | Virtual Address where the section begins. |
| `size` | `INTEGER` | Total bytes in the section. |
| `fileOffset` | `INTEGER` | Physical file offset for the section. |
| `unitBytes` | `INTEGER` | Byte size per visual grid unit on the frontend (default `64`). |
| `columns` | `INTEGER` | Number of columns for visual representation (default `64`). |

### `cells` Table
Represents chunks (cells) of memory to be rendered in the UI coverage map.

| Column | Type | Description |
|---|---|---|
| `id` | `INTEGER` | Auto-increment primary key. |
| `target` | `TEXT` | The binary target. |
| `section_name` | `TEXT` | The section this cell belongs to. Indexed. |
| `start` | `INTEGER` | Start offset of the cell. |
| `end` | `INTEGER` | End offset of the cell. |
| `span` | `INTEGER` | Width or span representation of the cell in bytes. |
| `state` | `TEXT` | Match state: `none`, `exact`, `reloc`, `matching`, `matching_reloc`, `stub`. |
| `functions` | `TEXT` | JSON array of function names mapping to this cell. |

### `metadata` Table
Stores arbitrary target-specific key-value pairs (e.g., summary statistics, file paths). Primary Key is `(target, key)`. Values are serialized JSON.

### `section_cell_stats` (View)
A SQLite view aggregating matching metrics to quickly pull total/exact/stub cells. It sums match types dynamically across `target` and `section_name`.

---

## 2. `reccmp` Database (In-Memory Entity Database)

### Overview
Instead of writing to disk, the `reccmp` matching pipeline uses a transient, in-memory SQLite database (`reccmp/compare/db.py`). It effectively operates as an ORM to relate parsed objects ("entities") between the original executable and the newly recompiled binary using a graph-like mapping table approach.

### `entities` Table
The primary source of truth storing matched and unmatched items.

| Column | Type | Description |
|---|---|---|
| `orig_addr` | `INTEGER` | (UNIQUE null-able) Virtual address in the original binary. |
| `recomp_addr` | `INTEGER` | (UNIQUE null-able) Virtual address in the recompiled binary. |
| `kvstore` | `TEXT` | JSON store containing entity metadata (e.g. `type`, `name`, `size`). Default: `{}` |

### `names` Table
An explicit cache of entity names to aid in resolving thunks and references across functions.

| Column | Type | Description |
|---|---|---|
| `img` | `INTEGER` | Enum denoting origin: `0` for original, `1` for recompiled. (Primary Key) |
| `addr` | `INTEGER` | Entity address. (Primary Key) |
| `name` | `TEXT` | Extracted name of the entity. |
| `computed_name` | `TEXT` | The algorithmically resolved or demangled function name. |

### `refs` Table
Used to store jump tables, destinations, and vtable dispatch targets for entities (especially `vtordisp` offsets and thunks).

| Column | Type | Description |
|---|---|---|
| `img` | `INTEGER` | `0` (original) or `1` (recomp). (Primary Key) |
| `addr` | `INTEGER` | Sub-address inside the thunk/dispatch. (Primary Key) |
| `ref` | `INTEGER` | Jump/Reference destination address. |
| `disp0` | `INTEGER` | Virtual dispatch displacement 0. |
| `disp1` | `INTEGER` | Virtual dispatch displacement 1. |

### Essential `reccmp` SQL Views
- **`matches`**: Filters `entities` natively yielding `orig_addr` and `recomp_addr` where **both** are explicitly populated (successfully matched pairs).
- **`match_ids`**: Flattens `matches` into a unified layout returning binary `img` index + its internal `addr`.
- **`orig_unmatched` / `recomp_unmatched`**: Helper views projecting sides of `entities` with dangling original or recompiled addresses without a counterpart.
